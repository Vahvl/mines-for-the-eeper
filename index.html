<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mines eeper</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="bar">
        <div>Time passed: <span id="time">0.00</span></div>
        <div>Personal Best: <span id="pb">No PB yet</span></div>
        <div>Mines Left: <span id="mineCount"></span></div>
    </div>
    <canvas id="canvas" width="400" height="400"></canvas>

    <div id="startScreen" class="screen">
        <h1>Mines eeper</h1>
        <p>Configure your settings:</p>
        <div class = "screenChild">
            <label for="width">Width:</label>
            <input type="number" id="width" value="30">
            <p id="warningWidth" class="warning">Width might be too large for your screen.</p>
            &nbsp;

            <label for="height">Height:</label>
            <input type="number" id="height" value="20">
            <p id="warningHeight" class="warning">Height might be too large for your screen.</p>
            &nbsp;

            <label for="mines">Mines:</label>
            <input type="number" id="mines" value="100">
            <p id="warningMine" class="warning">More mines than spaces available.</p>
            &nbsp;
        </div>

        <button onclick="startGame()">Start Game</button>
    </div>
    <div id="loseScreen" class="screen" style="display: none;">
        <h1>lol you lost</h1>
        <div class="screenChild" id="loseInfo">
            <p>Mines left: <span id="minesLost"></span></p>
            <p>Time Taken: <span id="timeLost"></span> seconds</p>
            <p>Personal Best: <span id="personalBest"></span></p>
        </div>
        <button onclick="startGame()">Try Again</button>
    </div>
    <div id="winScreen" class="screen" style = "display: none;"></div>

    <script src="js/board.js"></script>
    <script src="js/point.js"></script>
    <script src="js/tile.js"></script>

    <script>
        let gameState = 'START';
        const TILE_SIZE = 40;

        const WIDTH = localStorage.getItem('width') || 30;
        const HEIGHT = localStorage.getItem('height') || 20;
        const MINES = localStorage.getItem('mines') || 100;

        document.getElementById('width').value = WIDTH;
        document.getElementById('height').value = HEIGHT;
        document.getElementById('mines').value = MINES;

        const startScreen = document.getElementById("startScreen");
        const lostScreen = document.getElementById("loseScreen");
        const wonScreen = document.getElementById("winScreen");

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let board = new Board(WIDTH, HEIGHT, MINES);
        canvas.height = HEIGHT * TILE_SIZE;
        canvas.width = WIDTH * TILE_SIZE;

        animate();

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            board.draw(ctx);

            document.getElementById('mineCount').innerText = board.mines_left

            requestAnimationFrame(animate);
        }

        canvas.addEventListener('mouseup', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const i = Math.floor(x / TILE_SIZE);
            const j = Math.floor(y / TILE_SIZE);

            if (gameState === "PLAYING") board.click(new Point(i, j), e.button);
        });

        canvas.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        });

        function startGame() {
            const width = document.getElementById('width').value;
            const height = document.getElementById('height').value;
            const mines = document.getElementById('mines').value;

            localStorage.setItem('width', width);
            localStorage.setItem('height', height);
            localStorage.setItem('mines', mines);

            canvas.height = height * TILE_SIZE;
            canvas.width = width * TILE_SIZE;

            board = new Board(width, height, mines);
            gameState = 'PLAYING';
            startScreen.style.display = 'none';
            lostScreen.style.display = 'none';
            wonScreen.style.display = 'none';
        }

        function gameLost() {
            stopTimer(false);
            gameState = "LOST";
            lostScreen.style.display = "block";
    
            const minesLostElement = document.getElementById("minesLost");
            const timeLostElement = document.getElementById("timeLost");
            const personalBestElement = document.getElementById("personalBest");
    
            minesLostElement.innerText = `${board.mines_left}/${board.mine_count}`;
            timeLostElement.innerText = time.toFixed(2);
    
            const personalBest = localStorage.getItem('pb');
            personalBestElement.innerText = personalBest ? personalBest : "No Personal Best Yet";
        }

        /*
        * Timer
        */
        const timeElement = document.getElementById('time');

        if (localStorage.getItem('pb')) {
            document.getElementById('pb').innerText = localStorage.getItem('pb');
        }

        let time = 0;
        let timerInterval;
        function startTimer() {
            timerInterval = setInterval(() => {
                time += 0.01;
                timeElement.innerText = time.toFixed(2);
            }, 10);
        }

        function stopTimer(won = true) {
            clearInterval(timerInterval);

            if (!localStorage.getItem('pb') || time < localStorage.getItem('pb') && won) {
                document.getElementById('pb').innerText = time.toFixed(2);
                localStorage.setItem('pb', time.toFixed(2));
            }
        }
    </script>

    <!-- Input Validation -->
    <script>
        const widthInput = document.getElementById('width');
        const heightInput = document.getElementById('height');
        const minesInput = document.getElementById('mines');
    
        const warningWidth = document.getElementById('warningWidth');
        const warningHeight = document.getElementById('warningHeight');
        const warningMine = document.getElementById('warningMine');

        widthInput.addEventListener('input', checkWidth);
        heightInput.addEventListener('input', checkHeight);
        minesInput.addEventListener('input', checkMines);
    
        function checkWidth() {
            const width = parseInt(widthInput.value);
            if (width > window.innerWidth / 40) {
                warningWidth.style.display = 'block';
            } else {
                warningWidth.style.display = 'none';
            }
        }
    
        function checkHeight() {
            const height = parseInt(heightInput.value);
            if (height > window.innerHeight / 40) {
                warningHeight.style.display = 'block';
            } else {
                warningHeight.style.display = 'none';
            }
        }
    
        function checkMines() {
            const width = parseInt(widthInput.value);
            const height = parseInt(heightInput.value);
            const mines = parseInt(minesInput.value);
    
            const totalSpaces = width * height;
            if (mines > totalSpaces - 1) {
                warningMine.style.display = 'block';
            } else {
                warningMine.style.display = 'none';
            }
        }
    
        checkWidth();
        checkHeight();
        checkMines();
    </script>
    
</body>
</html>