<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mines eeper</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="bar">
        <div>Time passed: <span id="time">0.00</span></div>
        <div>Personal Best: <span id="pb">No PB yet</span></div>
        <div>Mines Left: <span id="mineCount"></span></div>
    </div>
    <canvas id="canvas" width="400" height="400"></canvas>

    <script src="js/board.js"></script>
    <script src="js/point.js"></script>
    <script src="js/tile.js"></script>

    <script>
        const TILE_SIZE = 40;

        const WIDTH = 10;
        const HEIGHT = 10;
        const MINES = 5;

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const board = new Board(WIDTH, HEIGHT, MINES);
        canvas.height = HEIGHT * TILE_SIZE;
        canvas.width = WIDTH * TILE_SIZE;

        animate();

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            board.draw(ctx);

            const flaggedCount = board.tiles.filter(t => t.flag).length;
            const minesLeft = board.bomb_count - flaggedCount
            document.getElementById('mineCount').innerText = minesLeft

            requestAnimationFrame(animate);
        }

        canvas.addEventListener('mouseup', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const i = Math.floor(x / TILE_SIZE);
            const j = Math.floor(y / TILE_SIZE);

            board.click(new Point(i, j), e.button);
        });

        canvas.addEventListener('contextmenu', function (e) {
            e.preventDefault();
        });

        /*
        * Timer
        */
        const timeElement = document.getElementById('time');

        if (localStorage.getItem('pb')) {
            document.getElementById('pb').innerText = localStorage.getItem('pb');
        }

        let time = 0;
        let timerInterval;
        function startTimer() {
            timerInterval = setInterval(() => {
                time += 0.01;
                timeElement.innerText = time.toFixed(2);
            }, 10);
        }

        function stopTimer() {
            clearInterval(timerInterval);

            if (!localStorage.getItem('pb') || time < localStorage.getItem('pb')) {
                document.getElementById('pb').innerText = time.toFixed(2);
                localStorage.setItem('pb', time.toFixed(2));
            }
        }
    </script>
</body>
</html>